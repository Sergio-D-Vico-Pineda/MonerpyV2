---
import Layout from "@layouts/Layout.astro";
import Footer from "@comps/Footer.astro";
import LogoutScript from "@comps/LogoutScript.astro";
import Header from "@comps/Header.astro";
import RecurringTransactionModal from "@comps/RecurringTransactionModal.astro";
import ToastScript from "@comps/ToastScript.astro";
import { actions } from "astro:actions";
import {
    formatDateForDisplay,
    getDatePart,
    getTimePartWithoutSeconds,
} from "@lib/date-utils.ts";

const user = Astro.locals.user;

if (!user) {
    return Astro.redirect("/login");
}

// Handle form submissions
let toastMessage = "";
let toastType = "success";

if (Astro.request.method === "POST") {
    const formData = await Astro.request.formData();
    const action = formData.get("_action") as string;

    if (action === "create") {
        const result = await Astro.callAction(
            actions.createRecurringTransaction,
            formData,
        );
        console.log("Create recurring transaction result:", result);
        if (result.data?.ok) {
            toastMessage = "Recurring transaction created successfully!";
            toastType = "success";
        } else {
            console.error(
                "Recurring transaction creation failed:",
                result.error || result.data?.error,
            );
            toastMessage = "Failed to create recurring transaction. Please try again.";
            toastType = "error";
        }
    } else if (action === "update") {
        const result = await Astro.callAction(
            actions.updateRecurringTransaction,
            formData,
        );
        console.log("Update recurring transaction result:", result);
        if (result.data?.ok) {
            toastMessage = "Recurring transaction updated successfully!";
            toastType = "success";
        } else {
            console.error(
                "Recurring transaction update failed:",
                result.error || result.data?.error,
            );
            toastMessage = "Failed to update recurring transaction. Please try again.";
            toastType = "error";
        }
    } else if (action === "delete") {
        const result = await Astro.callAction(
            actions.deleteRecurringTransaction,
            formData,
        );
        console.log("Delete recurring transaction result:", result);
        if (result.data?.ok) {
            toastMessage = "Recurring transaction deleted successfully!";
            toastType = "success";
        } else {
            console.error(
                "Recurring transaction deletion failed:",
                result.error || result.data?.error,
            );
            toastMessage = "Failed to delete recurring transaction. Please try again.";
            toastType = "error";
        }
    } else if (action === "generate") {
        const result = await Astro.callAction(
            actions.generateRecurringTransactions,
            formData,
        );
        console.log("Generate recurring transactions result:", result);
        if (result.data?.ok) {
            const generated = result.data.generated || 0;
            toastMessage = `Generated ${generated} transaction${generated !== 1 ? 's' : ''} successfully!`;
            toastType = "success";
        } else {
            console.error(
                "Recurring transaction generation failed:",
                result.error || result.data?.error,
            );
            toastMessage = "Failed to generate transactions. Please try again.";
            toastType = "error";
        }
    }
}

// Check if user is in a family first
const userResult = await Astro.callAction(actions.getFamilyDetails, {});
const userInFamily = userResult.data?.ok && userResult.data.family;

// Get accounts data only if user is in a family
const accountsResult = userInFamily
    ? await Astro.callAction(actions.getAccountsList, { includeDeleted: false })
    : { data: { ok: false, accounts: [] } };
const accounts = accountsResult.data?.ok ? accountsResult.data.accounts : [];

// Get data for the page only if user has accounts
const recurringTransactionsResult = userInFamily && accounts && accounts.length > 0
    ? await Astro.callAction(actions.getRecurringTransactions, {
        page: 1,
        limit: 20,
    })
    : { data: { ok: false, recurringTransactions: [], pagination: null } };

const recurringTransactions = recurringTransactionsResult.data?.ok
    ? recurringTransactionsResult.data.recurringTransactions
    : [];
const pagination = recurringTransactionsResult.data?.ok
    ? recurringTransactionsResult.data.pagination
    : null;

// Calculate next execution dates for active recurring transactions
const recurringTransactionsWithNextDates = (recurringTransactions ?? []).map(rt => {
    if (rt.status !== 'active') {
        return { ...rt, nextExecution: null, upcomingDates: [] };
    }

    const now = new Date();
    const startDate = new Date(rt.startDate);
    let nextDate = new Date(Math.max(startDate.getTime(), now.getTime()));

    // Calculate next execution date based on frequency
    const upcomingDates: Date[] = [];
    let tempDate = new Date(nextDate);

    for (let i = 0; i < 5; i++) {
        // Check end conditions
        const endDate = rt.endDate ? new Date(rt.endDate) : null;
        if (endDate && tempDate > endDate) break;
        if (rt.maxOccurrences && rt.occurrencesCount + i >= rt.maxOccurrences) break;

        switch (rt.frequency) {
            case 'Daily':
                tempDate = new Date(tempDate);
                tempDate.setDate(tempDate.getDate() + (i === 0 ? 0 : 1));
                break;
            case 'Weekly':
                if (i === 0) {
                    // Find next occurrence of the specified day of week
                    const currentDayOfWeek = tempDate.getDay();
                    const targetDayOfWeek = rt.dayOfWeek || 0;
                    const daysUntilNext = (targetDayOfWeek - currentDayOfWeek + 7) % 7;
                    tempDate.setDate(tempDate.getDate() + (daysUntilNext === 0 ? 7 : daysUntilNext));
                } else {
                    tempDate.setDate(tempDate.getDate() + 7);
                }
                break;
            case 'Monthly':
                if (i === 0) {
                    tempDate.setDate(rt.dayOfMonth || 1);
                    if (tempDate <= now) {
                        tempDate.setMonth(tempDate.getMonth() + 1);
                    }
                } else {
                    tempDate.setMonth(tempDate.getMonth() + 1);
                }
                break;
            case 'Yearly':
                if (i === 0) {
                    tempDate.setMonth(0); // January
                    tempDate.setDate(rt.dayOfMonth || 1);
                    if (tempDate <= now) {
                        tempDate.setFullYear(tempDate.getFullYear() + 1);
                    }
                } else {
                    tempDate.setFullYear(tempDate.getFullYear() + 1);
                }
                break;
        }

        upcomingDates.push(new Date(tempDate));
    }

    return {
        ...rt,
        nextExecution: upcomingDates[0] || null,
        upcomingDates
    };
});

// Helper function to get status color
function getStatusColor(status: string): string {
    switch (status) {
        case 'active': return 'text-green-400';
        case 'completed': return 'text-gray-400';
        case 'scheduled': return 'text-yellow-400';
        default: return 'text-gray-400';
    }
}

// Helper function to get status text
function getStatusText(status: string): string {
    switch (status) {
        case 'active': return 'Active';
        case 'completed': return 'Completed';
        case 'scheduled': return 'Scheduled';
        default: return 'Unknown';
    }
}
---

<Layout title="Recurring Transactions" description="Manage your recurring transactions">
    <main class="bg-gray-900 p-8 min-h-screen text-white">
        <Header currentPage="recurring" user={user} />

        <div class="mx-auto max-w-7xl">
            {
                !userInFamily ? (
                    <div>
                        <div class="bg-gray-800 shadow-lg px-8 py-12 rounded-lg text-center">
                            <div class="text-6xl mb-6">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                            <h2 class="text-2xl font-bold text-purple-400 mb-4">
                                Join a Family First
                            </h2>
                            <p class="text-gray-300 mb-6 max-w-md mx-auto">
                                You need to be part of a family to create and
                                manage recurring transactions. Families help organize finances
                                and allow multiple members to collaborate.
                            </p>
                            <div class="space-y-4">
                                <a
                                    href="/families"
                                    class="inline-block bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors"
                                >
                                    Go to Families Page
                                </a>
                                <p class="text-sm text-gray-400">
                                    Create a new family or join an existing one
                                    to get started
                                </p>
                            </div>
                        </div>
                    </div>
                ) : !accounts || accounts.length === 0 ? (
                    <div>
                        <div class="bg-gray-800 shadow-lg px-8 py-12 rounded-lg text-center">
                            <div class="text-6xl mb-6">üè¶</div>
                            <h2 class="text-2xl font-bold text-purple-400 mb-4">
                                Create an Account First
                            </h2>
                            <p class="text-gray-300 mb-6 max-w-md mx-auto">
                                You need at least one account to create recurring transactions.
                                Accounts help organize your finances and track where money comes from and goes to.
                            </p>
                            <div class="space-y-4">
                                <a
                                    href="/accounts"
                                    class="inline-block bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors"
                                >
                                    Go to Accounts Page
                                </a>
                                <p class="text-sm text-gray-400">
                                    Create your first account to start managing recurring transactions
                                </p>
                            </div>
                        </div>
                    </div>
                ) : (
                    <div>
            <!-- Quick Actions -->
            <div class="mb-6 flex gap-4 flex-wrap">
                <a
                    href="/transactions"
                    class="text-purple-400 hover:text-purple-300 flex items-center space-x-2"
                >
                    <span>‚Üê</span>
                    <span>Back to Transactions</span>
                </a>
                <button
                    type="button"
                    id="generateAllBtn"
                    class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-white transition duration-200"
                    title="Generate all pending transactions up to today"
                >
                    Generate All Pending
                </button>
            </div>

            <!-- Recurring Transactions List -->
            <div class="bg-gray-800 shadow-lg px-6 py-6 rounded-lg">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="font-semibold text-purple-400 text-xl">
                        Recurring Transactions
                    </h2>
                    <div class="flex gap-2">
                        <button
                            type="button"
                            id="addRecurringTransactionBtn"
                            class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded text-white transition duration-200"
                        >
                            Add Recurring Transaction
                        </button>
                    </div>
                </div>

                {
                    !recurringTransactions || recurringTransactions.length === 0 ? (
                        <div class="text-center py-12 text-gray-400">
                            <div class="text-6xl mb-4">üîÑ</div>
                            <p class="text-lg mb-2">No recurring transactions found</p>
                            <p class="text-sm">
                                Add your first recurring transaction to automate your finances!
                            </p>
                        </div>
                    ) : (
                        <div class="space-y-6">
                            {recurringTransactionsWithNextDates.map((recurringTransaction) => (
                                <div class="bg-gray-700 rounded-lg p-6 hover:bg-gray-650 transition-all duration-200 hover:shadow-md border border-gray-600 hover:border-gray-500">
                                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
                                        <!-- Main Info -->
                                        <div class="lg:col-span-5">
                                            <div class="flex items-start justify-between mb-3">
                                                <div class="flex-1">
                                                    <h3 class="font-semibold text-white text-lg leading-tight">
                                                        {recurringTransaction.description}
                                                    </h3>
                                                    <div class="flex items-center gap-2 mt-1">
                                                        <span class="text-sm text-gray-400">
                                                            {recurringTransaction.account.name}
                                                        </span>
                                                        <div
                                                            class="w-2 h-2 rounded-full"
                                                            style={`background-color: ${recurringTransaction.account.color}`}
                                                        />
                                                        <span class="text-xs text-gray-500">
                                                            {recurringTransaction.frequency}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class={`text-sm font-medium ${getStatusColor(recurringTransaction.status)}`}>
                                                    {getStatusText(recurringTransaction.status)}
                                                </div>
                                            </div>

                                            {/* Tags and Category */}
                                            <div class="flex items-center gap-2 flex-wrap mb-3">
                                                {recurringTransaction.category && (
                                                    <span
                                                        class="px-2 py-1 rounded-full text-xs font-medium text-white"
                                                        style={`background-color: ${recurringTransaction.category.color}`}
                                                    >
                                                        {recurringTransaction.category.name}
                                                    </span>
                                                )}
                                                {recurringTransaction.tags.map((tag) => (
                                                    <span
                                                        class="text-xs px-2 py-1 rounded-full text-white border"
                                                        style={`background-color: ${tag.color}; border-color: ${tag.color}`}
                                                    >
                                                        {tag.name}
                                                    </span>
                                                ))}
                                            </div>

                                            {/* Amount */}
                                            <div class={`text-xl font-bold ${
                                                recurringTransaction.type === "Income"
                                                    ? "text-green-400"
                                                    : "text-red-400"
                                            }`}>
                                                {recurringTransaction.type === "Income" ? "+" : "-"}
                                                {new Intl.NumberFormat("es-ES", {
                                                    style: "currency",
                                                    currency: "EUR",
                                                    minimumFractionDigits: 2,
                                                }).format(recurringTransaction.amount)}
                                            </div>
                                        </div>

                                        <!-- Schedule Info -->
                                        <div class="lg:col-span-4">
                                            <div class="text-sm text-gray-300 space-y-1">
                                                <div>
                                                    <span class="text-gray-400">Started:</span>
                                                    {formatDateForDisplay(recurringTransaction.startDate, { includeTime: false, dateStyle: 'short' })}
                                                </div>
                                                {recurringTransaction.endDate && (
                                                    <div>
                                                        <span class="text-gray-400">Ends:</span>
                                                        {formatDateForDisplay(recurringTransaction.endDate, { includeTime: false, dateStyle: 'short' })}
                                                    </div>
                                                )}
                                                {recurringTransaction.maxOccurrences && (
                                                    <div>
                                                        <span class="text-gray-400">Occurrences:</span>
                                                        {recurringTransaction.occurrencesCount} / {recurringTransaction.maxOccurrences}
                                                        {recurringTransaction.remainingOccurrences !== null && (
                                                            <span class="text-yellow-400 ml-1">
                                                                ({recurringTransaction.remainingOccurrences} left)
                                                            </span>
                                                        )}
                                                    </div>
                                                )}
                                                <div>
                                                    <span class="text-gray-400">Time:</span>
                                                    {recurringTransaction.timeOfDay}
                                                </div>
                                            </div>

                                            {/* Next Execution */}
                                            {recurringTransaction.nextExecution && (
                                                <div class="mt-3 p-2 bg-gray-600 rounded">
                                                    <div class="text-xs text-gray-400">Next:</div>
                                                    <div class="text-sm text-yellow-400 font-medium">
                                                        {formatDateForDisplay(
                                                            recurringTransaction.nextExecution.toISOString().replace('T', ' ').split('.')[0],
                                                            { includeTime: false, dateStyle: 'medium' }
                                                        )}
                                                    </div>
                                                </div>
                                            )}

                                            {/* Upcoming Dates Preview */}
                                            {recurringTransaction.upcomingDates && recurringTransaction.upcomingDates.length > 1 && (
                                                <div class="mt-2">
                                                    <div class="text-xs text-gray-400 mb-1">Upcoming:</div>
                                                    <div class="flex flex-wrap gap-1">
                                                        {recurringTransaction.upcomingDates.slice(1, 4).map((date) => (
                                                            <span class="text-xs bg-gray-600 px-2 py-1 rounded text-gray-300">
                                                                {date.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' })}
                                                            </span>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>

                                        <!-- Actions -->
                                        <div class="lg:col-span-3 flex lg:flex-col flex-row gap-2 lg:items-end">
                                            <button
                                                type="button"
                                                class="edit-btn bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded text-white transition duration-200 text-sm"
                                                data-recurring-transaction={JSON.stringify(recurringTransaction)}
                                                title="Edit recurring transaction"
                                            >
                                                Edit
                                            </button>
                                            
                                            {recurringTransaction.status === 'active' && (
                                                <button
                                                    type="button"
                                                    class="generate-btn bg-green-600 hover:bg-green-700 px-3 py-2 rounded text-white transition duration-200 text-sm"
                                                    data-id={recurringTransaction.id}
                                                    title="Generate pending transactions"
                                                >
                                                    Generate
                                                </button>
                                            )}
                                            
                                            <form method="POST" class="inline">
                                                <input type="hidden" name="_action" value="delete" />
                                                <input type="hidden" name="id" value={recurringTransaction.id} />
                                                <button
                                                    type="submit"
                                                    class="bg-red-600 hover:bg-red-700 px-3 py-2 rounded text-white transition duration-200 text-sm"
                                                    title="Delete recurring transaction"
                                                    onclick="return confirm('Are you sure you want to delete this recurring transaction? This will not affect already generated transactions.')"
                                                >
                                                    Delete
                                                </button>
                                            </form>
                                        </div>
                                    </div>

                                    <!-- Recent Transactions Log -->
                                    {recurringTransaction.logs && recurringTransaction.logs.length > 0 && (
                                        <div class="mt-4 pt-4 border-t border-gray-600">
                                            <div class="text-sm text-gray-400 mb-2">Recent Generated Transactions:</div>
                                            <div class="flex flex-wrap gap-2">
                                                {recurringTransaction.logs.slice(0, 3).map((log) => (
                                                    <div class="text-xs bg-gray-600 px-2 py-1 rounded">
                                                        {formatDateForDisplay(log.executionTime, { includeTime: false, dateStyle: 'short' })}
                                                        {log.generatedTransaction && (
                                                            <span class="text-green-400 ml-1">
                                                                ‚úì {new Intl.NumberFormat("es-ES", {
                                                                    style: "currency",
                                                                    currency: "EUR",
                                                                    minimumFractionDigits: 2,
                                                                }).format(log.generatedTransaction.amount)}
                                                            </span>
                                                        )}
                                                    </div>
                                                ))}
                                                {recurringTransaction.logs.length > 3 && (
                                                    <div class="text-xs text-gray-400 px-2 py-1">
                                                        +{recurringTransaction.logs.length - 3} more
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    )
                }

                {
                    pagination && pagination.totalPages > 1 && (
                        <div class="flex justify-center mt-6 gap-2">
                            {Array.from(
                                { length: pagination.totalPages },
                                (_, i) => (
                                    <a
                                        href={`/recurring?page=${i + 1}`}
                                        class={`px-3 py-2 rounded ${
                                            pagination.page === i + 1
                                                ? "bg-purple-600 text-white"
                                                : "bg-gray-700 text-gray-300 hover:bg-gray-600"
                                        }`}
                                    >
                                        {i + 1}
                                    </a>
                                ),
                            )}
                        </div>
                    )
                }
            </div>
                    </div>
                )
            }
    </main>
</Layout>

<RecurringTransactionModal />
{toastMessage && <ToastScript message={toastMessage} type={toastType} />}

<Footer />
<LogoutScript />

<script>
    // Add Recurring Transaction button functionality
    const addRecurringTransactionBtn = document.getElementById("addRecurringTransactionBtn");
    if (addRecurringTransactionBtn) {
        addRecurringTransactionBtn.addEventListener("click", function () {
            const openModal = (window as any).openRecurringTransactionModal;
            if (openModal) {
                openModal();
            }
        });
    }

    // Edit functionality
    document.querySelectorAll(".edit-btn").forEach((btn) => {
        btn.addEventListener("click", function (this: HTMLElement) {
            const recurringTransactionData = this.dataset.recurringTransaction;
            if (!recurringTransactionData) return;

            const recurringTransaction = JSON.parse(recurringTransactionData);
            const fillFormForEdit = (window as any).fillRecurringFormForEdit;
            if (fillFormForEdit) {
                fillFormForEdit(recurringTransaction);
            }
        });
    });

    // Generate functionality
    document.querySelectorAll(".generate-btn").forEach((btn) => {
        btn.addEventListener("click", function (this: HTMLElement) {
            const id = this.dataset.id;
            if (!id) return;

            if (confirm('Generate pending transactions for this recurring rule up to today?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.innerHTML = `
                    <input type="hidden" name="_action" value="generate">
                    <input type="hidden" name="recurringTransactionIds" value="${id}">
                    <input type="hidden" name="generateUpTo" value="today">
                `;
                document.body.appendChild(form);
                form.submit();
            }
        });
    });

    // Generate All functionality
    const generateAllBtn = document.getElementById("generateAllBtn");
    if (generateAllBtn) {
        generateAllBtn.addEventListener("click", function () {
            const activeIds = Array.from(document.querySelectorAll('.generate-btn'))
                .map(btn => (btn as HTMLElement).dataset.id)
                .filter(id => id);

            if (activeIds.length === 0) {
                alert('No active recurring transactions found.');
                return;
            }

            if (confirm(`Generate all pending transactions for ${activeIds.length} recurring rule${activeIds.length !== 1 ? 's' : ''} up to today?`)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.innerHTML = `
                    <input type="hidden" name="_action" value="generate">
                    <input type="hidden" name="recurringTransactionIds" value="${activeIds.join(',')}">
                    <input type="hidden" name="generateUpTo" value="today">
                `;
                document.body.appendChild(form);
                form.submit();
            }
        });
    }
</script>
